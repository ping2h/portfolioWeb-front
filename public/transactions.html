<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transactions & Trading | Portfolio Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4C6FFF;
            --primary-light: #6B8AFF;
            --secondary-color: #1BC5BD;
            --accent-color: #8950FC;
            --rise-color: #c46060e3;   /* 上涨 - 红色 */
            --fall-color: #10B981;     /* 下跌 - 绿色 */
            --warning-color: #F59E0B;
            
            --text-primary: #1D2129;
            --text-secondary: #4E5969;
            --text-tertiary: #6a6d72;
            --bg-light: rgba(255, 255, 255, 0.7);
            --bg-white: rgba(255, 255, 255, 0.85);
            --bg-card: rgba(255, 255, 255, 0.15);
            --card-border: rgba(255, 255, 255, 0.1);
            --divider: rgba(255, 255, 255, 0.15);
            --top-nav-gray: rgba(26, 26, 39, 0.85); /* 导航栏背景 - 半透明 */
            --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            --dropdown-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            --chart-bg: rgba(255, 255, 255, 0.26);
            --chart-line: #64748b;
            --chart-fill: rgba(94, 124, 226, 0.15);
            --chart-grid: rgba(148, 163, 184, 0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Manrope', 'Inter', sans-serif;
            color: var(--text-primary);
            padding-top: 70px;
            line-height: 1.6;
            min-height: 100vh;
            /* 背景图片设置 */
            background-image: url('https://www.10wallpaper.com/wallpaper/1366x768/2407/Modern_City_Night_Skyscrapers_Horizon_Dusk_5K_1366x768.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
        }
        
        /* 背景模糊遮罩 */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: inherit;
            filter: blur(5px); /* 轻微模糊效果 */
            z-index: -1;
            transform: scale(1.02); /* 解决边缘模糊问题 */
        }
        
        /* 顶部导航栏 - 液态玻璃效果 */
        .top-nav {
            background: var(--top-nav-gray);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: var(--card-shadow);
            padding: 0.5rem 1.5rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
            border-bottom: 1px solid var(--card-border);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-shrink: 0;
        }
        
        .logo h1 {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0;
            color: var(--bg-white);
            letter-spacing: -0.5px;
        }
        
        .logo h1 span {
            background: linear-gradient(to right, var(--primary-light), var(--accent-color));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-links {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0 0.5rem;
            flex: 1;
        }
        
        .nav-item {
            padding: 0.7rem 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.65rem;
            color: rgba(227, 222, 222, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 8px;
            font-size: 0.9rem;
            position: relative;
            font-weight: 500;
            flex-shrink: 0;
        }
        
        .nav-item:hover, .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            color: var(--bg-white);
        }
        
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: var(--secondary-color);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--secondary-color);
            display: block;
        }
        
        .nav-item i {
            width: 1.1rem;
            text-align: center;
            font-size: 1.1rem;
        }
        
        /* 搜索框样式 */
        .header-search-container {
            position: relative;
            width: 220px;
            transition: all 0.3s ease;
            flex-shrink: 1;
            min-width: 150px;
        }
        
        .header-search-input {
            width: 100%;
            padding: 0.7rem 0.85rem 0.7rem 2.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.15);
            color: var(--bg-white);
            font-weight: 500;
        }
        
        .header-search-icon {
            position: absolute;
            left: 0.85rem;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 1rem;
        }
        
        /* 用户菜单 */
        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            flex-shrink: 0;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .user-name {
            font-size: 0.9rem;
            font-weight: 500;
            display: none;
            color: var(--bg-white);
        }
        
        @media (min-width: 992px) {
            .user-name {
                display: block;
            }
        }
        
        .user-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 12px;
            box-shadow: var(--dropdown-shadow);
            width: 220px;
            padding: 0.75rem 0;
            margin: 0;
            list-style: none;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s ease;
            z-index: 1001;
            border: 1px solid var(--card-border);
        }
        
        .user-menu:hover .user-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .user-dropdown a {
            display: flex;
            align-items: center;
            gap: 0.85rem;
            padding: 0.85rem 1.5rem;
            color: var(--text-primary);
            text-decoration: none;
        }
        
        .user-dropdown a:hover {
            background: rgba(76, 111, 255, 0.1);
            color: var(--primary-color);
        }
        
        /* 主内容区样式 */
        .container {
            max-width: 1200px;
            margin: 1.25rem auto;
            padding: 0 1rem;
        }
        
        .page-title {
            font-size: 1.85rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--bg-white);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* 液态玻璃效果卡片 */
        .trade-section, .card {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            height: 100%;
            border: 1px solid var(--card-border);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .trade-section:hover, .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.2);
        }
        
        .section-title {
            font-size: 1.15rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--divider);
            color: var(--bg-white);
        }
        
        .trade-form .form-group {
            margin-bottom: 1rem;
        }
        
        .trade-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--bg-white);
        }
        
        .trade-form input, .trade-form select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.15);
            color: var(--bg-white);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .trade-form input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .trade-form input:focus, .trade-form select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 111, 255, 0.2);
        }
        
        .radio-group {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--bg-white);
        }
        
        .btn-trade {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .btn-buy {
            background: linear-gradient(90deg, #4C6FFF 25%, #6C8AFF 50%, #4C6FFF 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            color: white;
            border: none;
            transition: all 0.3s ease;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .btn-buy:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 111, 255, 0.4);
        }
        
        .btn-sell {
            background-color: var(--rise-color); /* 卖出按钮用红色 */
            color: white;
        }
        
        .btn-sell:hover {
            background-color: #b91c1c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(196, 96, 96, 0.4);
        }
        
        .stock-info {
            margin-top: 1rem;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stock-info.visible {
            display: block;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .info-label {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .info-value {
            font-weight: 500;
            color: var(--bg-white);
        }
        
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .filter-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .select-filter {
            padding: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.15);
            color: var(--bg-white);
            transition: border-color 0.2s ease;
        }
        
        .select-filter:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--divider);
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--bg-white);
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .transactions-table th,
        .transactions-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--divider);
            font-size: 0.9rem;
            color: var(--bg-white);
        }
        
        .transactions-table th {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
        }
        
        .transactions-table tr:hover td {
            background-color: rgba(76, 111, 255, 0.1);
        }
        
        .transaction-type {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .type-buy {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--fall-color); /* 买入用绿色 */
        }
        
        .type-sell {
            background-color: rgba(196, 96, 96, 0.2);
            color: var(--rise-color); /* 卖出用红色 */
        }
        
        .message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
            border: 1px solid transparent;
        }
        
        .message.success {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--fall-color);
            display: block;
            border-color: rgba(16, 185, 129, 0.3);
        }
        
        .message.error {
            background-color: rgba(196, 96, 96, 0.2);
            color: var(--rise-color);
            display: block;
            border-color: rgba(196, 96, 96, 0.3);
        }
        
        /* 红涨绿跌样式 */
        .change-positive {
            color: var(--rise-color); /* 上涨 - 红色 */
        }
        
        .change-negative {
            color: var(--fall-color); /* 下跌 - 绿色 */
        }
        
        .badge.bg-success {
            background-color: var(--rise-color) !important; /* 上涨 - 红色徽章 */
            color: white !important;
        }
        
        .badge.bg-danger {
            background-color: var(--fall-color) !important; /* 下跌 - 绿色徽章 */
            color: white !important;
        }
        
        /* 股票图表样式 - 优化部分 */
        #chartContainer {
            width: 100%;
            background: var(--chart-bg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 1rem;
            border: 1px solid var(--card-border);
        }
        
        #stockSelect {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 1rem;
            cursor: pointer;
            margin-right: 15px;
            background: rgba(255, 255, 255, 0.15);
            color: var(--bg-white);
            transition: border-color 0.2s ease;
        }
        
        #stockSelect:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        #fetchBtn {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(76, 111, 255, 0.2);
            transition: background-color 0.25s ease, box-shadow 0.25s ease, transform 0.2s ease;
        }
        
        #fetchBtn:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        
        #fetchBtn:hover:not(:disabled) {
            background-color: #3a5bdb;
            box-shadow: 0 6px 14px rgba(58, 91, 219, 0.3);
            transform: translateY(-1px);
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .transactions-table th:nth-child(5),
            .transactions-table td:nth-child(5) {
                display: none;
            }
            
            .header-search-container {
                order: 3;
                width: 100%;
                margin-top: 0.75rem;
            }
            
            .nav-item span {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .transactions-table th:nth-child(4),
            .transactions-table td:nth-child(4) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 - 液态玻璃效果 -->
    <div class="top-nav">
        <div class="logo">
            <i class="fas fa-chart-line fa-lg" style="color: var(--primary-light);"></i>
            <h1>Portfolio <span>Pro</span></h1>
        </div>
        
        <div class="nav-links">
            <a href="index.html" class="nav-item">
                <i class="fas fa-home"></i> <span>Dashboard</span>
            </a>
            <a href="cash.html" class="nav-item">
                <i class="fas fa-wallet"></i> <span>Cash</span>
            </a>
            <a href="stocks.html" class="nav-item">
                <i class="fas fa-chart-line"></i> <span>Stocks</span>
            </a>
            <a href="transactions.html" class="nav-item active">
                <i class="fas fa-exchange-alt"></i> <span>Transactions</span>
            </a>
        </div>
        
        <!-- 搜索框 -->
        <!-- <div class="header-search-container">
            <i class="fas fa-search header-search-icon"></i>
            <input type="text" class="header-search-input" placeholder="Search stocks, bonds...">
        </div> -->

          <div class="header-search-container" style="position: relative;">
                <i class="fas fa-search header-search-icon"></i>
                <input type="text" class="header-search-input" placeholder="Search stocks...">
                <ul class="search-suggestions"
                    style="position:absolute; top:100%; left:0; right:0; background:white; border:1px solid #ccc; list-style:none; margin:0; padding:0; z-index:1000;">
                </ul>
            </div>
        
        <div class="user-menu">
            <div class="user-avatar" title="John Doe">JD</div>
            <span class="user-name">John Doe</span>
            <i class="fas fa-chevron-down"></i>
            
            <ul class="user-dropdown">
                    <a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </li>
            </ul>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="container">
        <h1 class="page-title">Transactions & Trading</h1>
        
        <div class="content-grid">
            <!-- 左侧：交易表单 -->
            <div class="trade-section">
                <h2 class="section-title">Trade Assets</h2>
                
                <div id="trade-message" class="message"></div>
                
                <form id="trade-form" class="trade-form">
                    <div class="form-group">
                        <label for="stock-symbol">Ticker Symbol</label>
                        <input type="text" id="stock-symbol" placeholder="e.g. AAPL, TSLA, BTC" required 
                               style="text-transform: uppercase;" maxlength="10">
                    </div>
                    
                    <div class="form-group">
                        <label for="quantity">Quantity</label>
                        <input type="number" id="quantity" min="0.0001" step="0.0001" placeholder="Enter quantity" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Action</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="action-buy" name="action" value="buy" checked>
                                <label for="action-buy">Buy</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="action-sell" name="action" value="sell">
                                <label for="action-sell">Sell</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="stock-info" class="stock-info">
                        <div class="info-row">
                            <span class="info-label">Asset Name:</span>
                            <span class="info-value" id="asset-name">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Current Price:</span>
                            <span class="info-value" id="current-price">$0.00</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Price Change:</span>
                            <span class="info-value" id="price-change">$0.00</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Total Value:</span>
                            <span class="info-value" id="total-value">$0.00</span>
                        </div>
                        
                        <div class="info-row" id="holding-info">
                            <span class="info-label">Your Holdings:</span>
                            <span class="info-value" id="your-holdings">0</span>
                        </div>
                    </div>
                    
                    <button type="submit" id="submit-trade" class="btn-trade btn-buy">
                        <i class="fas fa-shopping-cart"></i> Buy Asset
                    </button>
                </form>
            </div>
            
            <!-- 右侧：股票开盘价图表 -->
            <div class="trade-section">
                <h2 class="section-title">Stock Opening Price Inquiry</h2>
                
                <div>
                    <label for="stockSelect">Select stocks</label>
                    <select id="stockSelect" aria-label="Select Stock">
                        <option value="TSLA" selected>Tesla TSLA</option>
                        <option value="AAPL">Apple AAPL</option>
                        <option value="GOOGL">Alphabet GOOGL</option>
                        <option value="MSFT">Microsoft MSFT</option>
                        <option value="AMZN">Amazon AMZN</option>
                        <option value="NFLX">Netflix NFLX</option>
                        <option value="NVDA">NVIDIA NVDA</option>
                        <option value="BABA">Alibaba BABA</option>
                        <option value="META">Meta META</option>
                    </select>
                    <button id="fetchBtn">Load the opening price</button>
                </div>
                
                <div id="chartContainer">
                    <canvas id="openPriceChart" height="400"></canvas>
                </div>
            </div>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label class="filter-label">Transaction Type</label>
                <select id="type-filter" class="select-filter">
                    <option value="all">All Types</option>
                    <option value="buy">Buy</option>
                    <option value="sell">Sell</option>
                </select>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <span>Transaction Records</span>
                <span id="transaction-count">Showing up to 10 transactions</span>
            </div>
            <div class="card-body">
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Asset</th>
                            <th>Type</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Total Value</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-table-body">
                        <tr>
                            <td colspan="7" class="text-center">Loading transactions...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>

         let stockList = [];

            window.addEventListener('DOMContentLoaded', async () => {
            // 获取 symbol 列表
            const res = await fetch('/assetList/getall');
            stockList = await res.json();
            });

            const input = document.querySelector('.header-search-input');
            const suggestions = document.querySelector('.search-suggestions');

            input.addEventListener('input', () => {
            const query = input.value.trim().toLowerCase();
            suggestions.innerHTML = '';

            if (!query) return;

            const matches = stockList.filter(stock =>
                stock.symbol.toLowerCase().includes(query) ||
                stock.name.toLowerCase().includes(query)
            );

            matches.forEach(stock => {
                const li = document.createElement('li');
                li.innerHTML = `<a href="/transactions.html" style="display:block; padding:8px;">${stock.symbol} - ${stock.name}</a>`;
                suggestions.appendChild(li);
            });
            });
        // API基础URL
        const API_BASE_URL = 'http://localhost:80';
        let allPositions = [];
        let allTransactions = [];
        // 使用模拟数据模式
        const USE_MOCK_DATA = true;
               // logout 
        document.getElementById('logout-btn').addEventListener('click', async function (e) {
    e.preventDefault(); // 阻止默认跳转行为

    try {
      const res = await fetch('/user/logout', {
        method: 'POST', // 根据你后端写法决定是 GET 还是 POST
        credentials: 'include' 
      });

      if (res.ok) {
        window.location.href = '/login.html'; // 注销成功后跳转到登录页面
      } else {
        alert('Logout failed.');
      }
    } catch (err) {
      console.error('Logout error:', err);
      alert('Network error.');
    }
  });
        // 股票图表相关配置
        const STOCK_API_KEY = 'a197aab59f1f4a73b2c41b4b83298b61'; // 建议替换为自己的API密钥
        let chartInstance = null;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 性能优化：使用requestAnimationFrame延迟初始化非关键组件
            requestAnimationFrame(() => {
                // 根据模式选择获取数据的方式
                if (USE_MOCK_DATA) {
                    loadMockPositions();
                    loadMockTransactions();
                } else {
                    fetchPositions();
                    fetchTransactions();
                }
                setupEventListeners();
                // 初始化股票图表
                loadChart();
            });
        });
        
        // 模拟持仓数据
        function loadMockPositions() {
            allPositions = [
                { symbol: 'AAPL', name: 'Apple Inc.', shares: 15, current_price: 178.32 },
                { symbol: 'MSFT', name: 'Microsoft Corp.', shares: 10, current_price: 338.45 },
                { symbol: 'TSLA', name: 'Tesla Inc.', shares: 5, current_price: 240.12 },
                { symbol: 'BTC', name: 'Bitcoin', shares: 0.25, current_price: 42500.75 },
                { symbol: 'USB10Y', name: 'US 10 Year Treasury', shares: 1000, current_price: 99.85 }
            ];
            console.log('Loaded mock positions:', allPositions);
        }
        
        // 模拟交易数据
        function loadMockTransactions() {
            allTransactions = getMockTransactions();
            loadTransactions();
        }
        
        // 从API获取所有持仓数据
        async function fetchPositions() {
            try {
                const response = await fetch(`${API_BASE_URL}/position/all`);
                
                if (!response.ok) {
                    const errorContent = await response.text();
                    console.error('API Error Response:', errorContent);
                    throw new Error(`Failed to fetch positions (${response.status} ${response.statusText})`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const nonJsonContent = await response.text();
                    console.error('Expected JSON but got:', nonJsonContent);
                    throw new Error('API did not return JSON data');
                }
                
                allPositions = await response.json();
                console.log('Fetched positions:', allPositions);
                
            } catch (error) {
                console.error('Error fetching positions:', error);
                showMessage(`Failed to load market data: ${error.message}. Using mock data instead.`, 'error');
                // 加载模拟数据作为备选
                loadMockPositions();
            }
        }
        
        // 获取所有交易记录
        async function fetchTransactions() {
            try {
                const transactionsTable = document.getElementById('transactions-table-body');
                transactionsTable.innerHTML = '<tr><td colspan="7" class="text-center">Loading transactions...</td></tr>';
                
                const response = await fetch(`${API_BASE_URL}/transactions`);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch transactions (${response.status} ${response.statusText})`);
                }
                
                allTransactions = await response.json();
                loadTransactions();
                
            } catch (error) {
                console.error('Error fetching transactions:', error);
                showMessage(`Failed to load transactions: ${error.message}. Using mock data instead.`, 'error');
                // 加载模拟数据作为备选
                loadMockTransactions();
            }
        }
        
        // 加载交易记录
        function loadTransactions() {
            const typeFilter = document.getElementById('type-filter').value;
            
            // 应用过滤（只保留交易类型过滤）
            const filteredTransactions = allTransactions.filter(transaction => {
                if (typeFilter !== 'all' && transaction.type !== typeFilter) return false;
                return true;
            });
            
            // 限制显示数量
            const limitedTransactions = filteredTransactions.slice(0, 10);
            
            document.getElementById('transaction-count').textContent = 
                `Showing ${limitedTransactions.length} of ${filteredTransactions.length} transactions`;
            
            renderTransactionsTable(limitedTransactions);
        }
        
        // 渲染交易记录表格
        function renderTransactionsTable(transactions) {
            const tableBody = document.getElementById('transactions-table-body');
            const fragment = document.createDocumentFragment(); // 性能优化：使用文档片段减少重绘
            
            if (transactions.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">No transactions found matching your criteria</td>
                    </tr>
                `;
                return;
            }
            
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.symbol} (${transaction.name})</td>
                    <td>
                        <span class="transaction-type type-${transaction.type}">
                            ${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}
                        </span>
                    </td>
                    <td>${transaction.quantity}</td>
                    <td>$${parseFloat(transaction.price).toFixed(2)}</td>
                    <td>$${parseFloat(transaction.totalValue).toFixed(2)}</td>
                    <td>${transaction.status}</td>
                `;
                fragment.appendChild(row);
            });
            
            tableBody.innerHTML = '';
            tableBody.appendChild(fragment);
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 为Ticker Symbol输入框添加点击事件，实现点击时显示价格
            const stockSymbolInput = document.getElementById('stock-symbol');
            stockSymbolInput.addEventListener('click', handleSymbolClick);
            
            // 性能优化：输入防抖
            const debouncedSymbolInput = debounce(handleSymbolInput, 300);
            stockSymbolInput.addEventListener('input', debouncedSymbolInput);
            
            const debouncedQuantityInput = debounce(calculateTotalValue, 150);
            document.getElementById('quantity').addEventListener('input', debouncedQuantityInput);
            
            document.querySelectorAll('input[name="action"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const action = this.value;
                    const button = document.getElementById('submit-trade');
                    
                    if (action === 'buy') {
                        button.className = 'btn-trade btn-buy';
                        button.innerHTML = '<i class="fas fa-shopping-cart"></i> Buy Asset';
                    } else {
                        button.className = 'btn-trade btn-sell';
                        button.innerHTML = '<i class="fas fa-arrow-circle-right"></i> Sell Asset';
                    }
                    
                    updateHoldingInfo();
                    calculateTotalValue();
                });
            });
            
            document.getElementById('trade-form').addEventListener('submit', handleTradeSubmit);
            document.getElementById('type-filter').addEventListener('change', loadTransactions);
            
            // 股票图表事件监听
            document.getElementById('fetchBtn').addEventListener('click', loadChart);
        }
        
        // 处理Ticker Symbol点击事件
        async function handleSymbolClick() {
            const symbol = document.getElementById('stock-symbol').value.trim().toUpperCase();
            
            // 如果已有输入值，直接获取价格
            if (symbol) {
                await fetchAndDisplayStockPrice(symbol);
            } else {
                // 如果没有输入值，显示提示信息
                document.getElementById('asset-name').textContent = 'Please enter a ticker symbol';
                document.getElementById('current-price').textContent = '$0.00';
                document.getElementById('price-change').textContent = '$0.00';
                document.getElementById('stock-info').classList.add('visible');
            }
        }
        
        // 获取并显示股票价格
        async function fetchAndDisplayStockPrice(symbol) {
            try {
                // 显示加载状态
                document.getElementById('asset-name').textContent = 'Loading...';
                document.getElementById('current-price').textContent = 'Loading...';
                document.getElementById('price-change').textContent = 'Loading...';
                document.getElementById('stock-info').classList.add('visible');
                
                // 调用价格API
                const response = await fetch(`${API_BASE_URL}/assetList/getpriceAndCh?symbol=${symbol}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch price for ${symbol}`);
                }
                
                const data = await response.json();
                
                // 查找资产名称
                const asset = allPositions.find(item => item.symbol === symbol);
                const assetName = asset ? asset.name : `${symbol} (Unknown)`;
                
                // 更新显示
                document.getElementById('asset-name').textContent = assetName;
                document.getElementById('current-price').textContent = `$${parseFloat(data.price).toFixed(2)}`;
                
                // 设置价格变动的颜色
                const priceChangeEl = document.getElementById('price-change');
                priceChangeEl.textContent = `$${parseFloat(data.change).toFixed(2)}`;
                priceChangeEl.className = 'info-value';
                
                if (data.change > 0) {
                    priceChangeEl.classList.add('change-positive');
                } else if (data.change < 0) {
                    priceChangeEl.classList.add('change-negative');
                }
                
                updateHoldingInfo();
                calculateTotalValue();
                
            } catch (error) {
                console.error('Error fetching stock price:', error);
                
                // 尝试使用模拟数据
                const asset = allPositions.find(item => item.symbol === symbol);
                if (asset) {
                    document.getElementById('asset-name').textContent = asset.name;
                    document.getElementById('current-price').textContent = `$${parseFloat(asset.current_price).toFixed(2)}`;
                    
                    // 生成随机价格变动
                    const randomChange = (Math.random() * 5 - 2.5).toFixed(2);
                    const priceChangeEl = document.getElementById('price-change');
                    priceChangeEl.textContent = `$${randomChange}`;
                    priceChangeEl.className = 'info-value';
                    
                    if (parseFloat(randomChange) > 0) {
                        priceChangeEl.classList.add('change-positive');
                    } else {
                        priceChangeEl.classList.add('change-negative');
                    }
                    
                    updateHoldingInfo();
                    calculateTotalValue();
                } else {
                    document.getElementById('asset-name').textContent = `${symbol} not found`;
                    document.getElementById('current-price').textContent = '$0.00';
                    document.getElementById('price-change').textContent = '$0.00';
                }
            }
        }
        
        // 防抖函数 - 性能优化
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        
        // 处理代码输入
        function handleSymbolInput() {
            const symbol = document.getElementById('stock-symbol').value.trim().toUpperCase();
            
            if (!symbol) {
                document.getElementById('stock-info').classList.remove('visible');
                return;
            }
            
            // 调用API获取价格
            fetchAndDisplayStockPrice(symbol);
        }
        
        // 更新持有信息
        function updateHoldingInfo() {
            const symbol = document.getElementById('stock-symbol').value.trim().toUpperCase();
            const isSellAction = document.getElementById('action-sell').checked;
            
            // 查找资产
            const asset = allPositions.find(item => item.symbol === symbol);
            
            const yourHoldings = document.getElementById('your-holdings');
            
            if (asset && isSellAction) {
                yourHoldings.textContent = `${asset.shares} units`;
            } else if (isSellAction) {
                yourHoldings.textContent = '0 units (Not in portfolio)';
            } else {
                yourHoldings.textContent = asset ? `${asset.shares} units (currently held)` : '0 units (Not held)';
            }
        }
        
        // 计算总价值
        function calculateTotalValue() {
            const symbol = document.getElementById('stock-symbol').value.trim().toUpperCase();
            const quantity = parseFloat(document.getElementById('quantity').value) || 0;
            
            if (!symbol || quantity <= 0) return;
            
            // 从显示的当前价格获取数值
            const priceText = document.getElementById('current-price').textContent;
            const currentPrice = parseFloat(priceText.replace('$', '')) || 0;
            
            const totalValue = quantity * currentPrice;
            document.getElementById('total-value').textContent = `$${totalValue.toFixed(2)}`;
        }
        
        // 处理交易提交
        async function handleTradeSubmit(e) {
            e.preventDefault();
            
            const symbol = document.getElementById('stock-symbol').value.trim().toUpperCase();
            const quantity = parseFloat(document.getElementById('quantity').value) || 0;
            const action = document.querySelector('input[name="action"]:checked').value;
            
            if (!symbol || quantity <= 0) {
                showMessage('Please enter valid symbol and quantity', 'error');
                return;
            }
            
            if (action === 'sell') {
                // 查找资产
                const asset = allPositions.find(item => item.symbol === symbol);
                if (!asset || parseFloat(asset.shares) < quantity) {
                    showMessage(`Insufficient shares. You have ${asset ? asset.shares : 0} units.`, 'error');
                    return;
                }
            }
            
            try {
                // 如果使用模拟数据模式，直接模拟交易成功
                if (USE_MOCK_DATA) {
                    // 找到对应的资产并更新持仓
                    const assetIndex = allPositions.findIndex(item => item.symbol === symbol);
                    if (assetIndex !== -1) {
                        if (action === 'buy') {
                            allPositions[assetIndex].shares = (parseFloat(allPositions[assetIndex].shares) + quantity).toFixed(4);
                        } else {
                            allPositions[assetIndex].shares = (parseFloat(allPositions[assetIndex].shares) - quantity).toFixed(4);
                        }
                    } else if (action === 'buy') {
                        // 添加新资产
                        allPositions.push({
                            symbol: symbol,
                            name: `${symbol} Asset`,
                            shares: quantity.toFixed(4),
                            current_price: Math.random() * 100 + 10 // 随机价格
                        });
                    }
                    
                    // 添加新交易记录
                    const currentPrice = document.getElementById('current-price').textContent.replace('$', '');
                    const newTransaction = {
                        id: Date.now(),
                        date: new Date().toISOString(),
                        symbol: symbol,
                        name: document.getElementById('asset-name').textContent,
                        type: action,
                        quantity: quantity.toFixed(4),
                        price: currentPrice,
                        totalValue: (quantity * parseFloat(currentPrice)).toFixed(2),
                        status: 'Completed'
                    };
                    
                    allTransactions.unshift(newTransaction); // 添加到交易记录开头
                    loadTransactions(); // 刷新交易记录
                    
                    showMessage(`${action.charAt(0).toUpperCase() + action.slice(1)} successful: ${quantity} ${symbol}`, 'success');
                    document.getElementById('trade-form').reset();
                    document.getElementById('stock-info').classList.remove('visible');
                    return;
                }
                
                // 调用API处理交易
                const url = `${API_BASE_URL}/position/${action}`;
                const requestData = {
                    symbol: symbol,
                    shares: quantity.toString()
                };
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const contentType = response.headers.get('content-type');
                let result;
                
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const responseText = await response.text();
                    console.error('Non-JSON response:', responseText);
                    result = { message: responseText };
                }
                
                if (!response.ok) {
                    throw new Error(result.message || `Failed to ${action} asset (${response.status})`);
                }
                
                showMessage(`${action.charAt(0).toUpperCase() + action.slice(1)} successful: ${quantity} ${symbol}`, 'success');
                fetchPositions();
                fetchTransactions();
                document.getElementById('trade-form').reset();
                document.getElementById('stock-info').classList.remove('visible');
                
            } catch (error) {
                console.error(`Error ${action}ing asset:`, error);
                showMessage(error.message || `Failed to process ${action}`, 'error');
            }
        }
        
        // 显示消息提示
        function showMessage(text, type) {
            const messageElement = document.getElementById('trade-message');
            messageElement.textContent = text;
            messageElement.className = 'message';
            messageElement.classList.add(type);
            
            setTimeout(() => {
                messageElement.className = 'message';
            }, 5000);
        }
        
        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        }
        
        // 生成模拟交易记录
        function getMockTransactions() {
            const mockTransactions = [];
            const types = ['buy', 'sell'];
            const statuses = ['Completed', 'Pending'];
            
            if (allPositions.length > 0) {
                allPositions.forEach(asset => {
                    const count = Math.floor(Math.random() * 4) + 2;
                    
                    for (let i = 0; i < count; i++) {
                        const type = types[Math.floor(Math.random() * types.length)];
                        const shares = (Math.random() * parseFloat(asset.shares) * 0.5).toFixed(4);
                        const price = (parseFloat(asset.current_price) * (0.9 + Math.random() * 0.2)).toFixed(2);
                        const totalValue = (parseFloat(shares) * parseFloat(price)).toFixed(2);
                        
                        const date = new Date();
                        date.setDate(date.getDate() - Math.floor(Math.random() * 30));
                        
                        mockTransactions.push({
                            id: Date.now() + i,
                            date: date.toISOString(),
                            symbol: asset.symbol,
                            name: asset.name,
                            type: type,
                            quantity: shares,
                            price: price,
                            totalValue: totalValue,
                            status: statuses[Math.floor(Math.random() * statuses.length)]
                        });
                    }
                });
            }
            
            // 按日期排序（最新的在前）
            return mockTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
        }
        
        // 股票图表相关函数 - 优化部分
        function formatStockDate(dateStr) {
            const parts = dateStr.split(' ')[0].split('-');
            return `${parseInt(parts[1], 10)}/${parseInt(parts[2], 10)}`;
        }
        
        async function fetchOpenPrices(symbol) {
            const url = `https://api.twelvedata.com/time_series?symbol=${symbol}&interval=1day&apikey=${STOCK_API_KEY}&outputsize=15`;
            const res = await fetch(url);
            return res.json();
        }
        
        async function loadChart() {
            const symbol = document.getElementById('stockSelect').value;
            const fetchBtn = document.getElementById('fetchBtn');
            fetchBtn.disabled = true;
            fetchBtn.textContent = 'Loading...';
            
            try {
                const data = await fetchOpenPrices(symbol);
                
                if (data.status === 'error') {
                    alert('API错误:' + data.message);
                    // 使用模拟图表数据
                    loadMockChart(symbol);
                    fetchBtn.disabled = false;
                    fetchBtn.textContent = 'Load the opening price';
                    return;
                }
                
                const dates = data.values.map(v => formatStockDate(v.datetime)).reverse();
                const opens = data.values.map(v => parseFloat(v.open)).reverse();
                
                if (chartInstance) {
                    chartInstance.destroy();
                }
                
                // 图表配置 - 使用浅色主题，减小点大小
                chartInstance = new Chart(document.getElementById('openPriceChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: `${symbol} Open Price (USD)`,
                            data: opens,
                            borderColor: '#4C6FFF', // 较浅的线条颜色
                            backgroundColor: 'rgba(76, 111, 255, 0.1)', // 更浅的填充色
                            fill: true,
                            tension: 0.3,
                            pointRadius: 3, // 减小点大小
                            pointHoverRadius: 5, // 减小悬停点大小
                            pointBackgroundColor: '#475569', // 点的颜色
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#ffffff',
                                    font: { weight: '600' }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                backgroundColor: 'rgba(255, 255, 255, 0.8)',
                                titleColor: '#1e293b',
                                bodyColor: '#334155',
                                borderColor: 'rgba(148, 163, 184, 0.2)',
                                borderWidth: 1,
                                padding: 12,
                                boxPadding: 6,
                                usePointStyle: true,
                                callbacks: {
                                    label: function(context) {
                                        return `Price: $${context.raw.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date',
                                    color: '#ffffff',
                                    font: { weight: '600' }
                                },
                                ticks: { color: '#ffffff' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Open Price(USD)',
                                    color: '#ffffff',
                                    font: { weight: '600' }
                                },
                                ticks: { color: '#ffffff' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                beginAtZero: false,
                            }
                        }
                    }
                });
                
            } catch (err) {
                console.error('Chart error:', err);
                alert('请求失败：' + err.message + '，使用模拟数据');
                loadMockChart(symbol);
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.textContent = 'Load the opening price';
            }
        }
        
        // 加载模拟图表数据 - 同样应用浅色主题和小点
        function loadMockChart(symbol) {
            // 生成过去15天的日期
            const dates = [];
            const today = new Date();
            for (let i = 14; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                dates.push(`${date.getMonth() + 1}/${date.getDate()}`);
            }
            
            // 生成随机价格数据，带有一定的趋势
            const basePrice = Math.random() * 100 + (symbol === 'BTC' ? 30000 : 50);
            const prices = [];
            let price = basePrice;
            
            for (let i = 0; i < 15; i++) {
                // 随机波动，范围为当前价格的-2%到+2%
                const change = price * (Math.random() * 0.04 - 0.02);
                price += change;
                prices.push(price);
            }
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            chartInstance = new Chart(document.getElementById('openPriceChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: `${symbol} Open Price (USD)`,
                        data: prices,
                        borderColor: '#64748b', // 浅色线条
                        backgroundColor: 'rgba(94, 124, 226, 0.15)', // 浅色填充
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3, // 小点
                        pointHoverRadius: 5, // 小悬停点
                        pointBackgroundColor: '#475569',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#ffffff',
                                font: { weight: '600' }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(255, 255, 255, 0.8)',
                            titleColor: '#1e293b',
                            bodyColor: '#334155',
                            borderColor: 'rgba(148, 163, 184, 0.2)',
                            borderWidth: 1,
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Date',
                                color: '#ffffff',
                                font: { weight: '600' }
                            },
                            ticks: { color: '#ffffff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Open Price(USD)',
                                color: '#ffffff',
                                font: { weight: '600' }
                            },
                            ticks: { color: '#ffffff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            beginAtZero: false,
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>